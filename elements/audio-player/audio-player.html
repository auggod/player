<link rel="import" href="../../bower_components/polymer/polymer.html"/><link rel="import" href="../play-button/play-button.html"/><link rel="import" href="../player-data/player-data.html"/><link rel="import" href="../progress-bar/progress-bar.html"/><link rel="import" href="../player-timer/player-timer.html"/><dom-module id="audio-player"><template><style>:host{display:flex;flex-direction:column;padding:10px;margin-bottom:20px;border-radius:4px;background:RGBA(46,66,184,1);color:#fff}img.play-button{border-radius:50%}.progress-seeker{position:absolute;top:0;cursor:pointer;z-index:10;width:100%;height:100%}player-metas{margin:10px;flex:1;display:flex;flex-direction:column}</style><player-data track="[[data]]"> <play-button on-click="playPause" paused="[[paused]]" playing="[[playing]]" artwork="[[artwork]]"></play-button><player-metas><span class="user">{{data.user.username}}</span><span class="title">{{data.title}}</span></player-metas><player-timer time="[[_secondesToMinutesAndSeconds(currentTime)]]"></player-timer><progress-bar progress="[[progress]]"><div on-click="seek" class="progress-seeker"></div></progress-bar><player-timer time="[[_secondesToMinutesAndSeconds(duration)]]"></player-timer></player-data><content></content></template><script>// Generated by LiveScript 1.4.0
(function(){
  var audio;
  audio = document.createElement('audio');
  Polymer({
    is: 'audio-player',
    ready: function(){
      this.name = "Audio player";
      window.onhashchange = function(e){
        return console.log(e);
      }.bind(this);
      window.onpopstate = function(e){
        return console.log(e);
      }.bind(this);
      document.addEventListener('pause', function(e){
        if (e.detail.playing === this.src) {
          return this.playing = false;
        }
      }.bind(this));
      return document.addEventListener('play', function(e){
        if (this.playing && e.detail.playing !== this.src) {
          this.pausedAt = this.currentTime;
          return this.playPause();
        }
      }.bind(this));
    },
    listeners: {
      'keydown': 'handleKeyDown',
      'click': 'handleClick',
      'play': 'handlePlay',
      'pause': 'handlePause'
    },
    handleKeyDown: function(e){
      if (e.keyCode === 32) {
        return this.playPause();
      }
    },
    handleClick: function(e){
      return console.log(e);
    },
    handlePlay: function(e){
      return console.log('play', this.data.title, e);
    },
    handlePause: function(e){
      return console.log('pause', this.data.title, e);
    },
    hostAttributes: {
      tabindex: 0
    },
    properties: {
      tracks: {
        type: Array
      },
      progress: {
        type: Number
      },
      duration: {
        type: Number,
        notify: true
      },
      currentTime: {
        type: Number,
        notify: true
      },
      data: {
        type: Object,
        notify: true
      },
      streamable: {
        type: Boolean,
        value: true
      },
      artwork: {
        type: String,
        notify: true
      },
      src: {
        type: String,
        notify: true
      },
      playing: {
        type: Boolean,
        notify: true,
        value: false
      },
      paused: {
        type: Boolean,
        notify: true,
        value: false
      },
      pausedAt: {
        type: Number,
        notify: true
      }
    },
    _secondesToMinutesAndSeconds: function(seconds){
      var minutes;
      if (!this.playing && this.playing !== this.src) {
        return;
      }
      minutes = Math.floor(seconds / 60);
      minutes = minutes >= 10
        ? minutes
        : '0' + minutes;
      seconds = Math.floor(seconds % 60);
      seconds = seconds >= 10
        ? seconds
        : '0' + seconds;
      return minutes + ':' + seconds;
    },
    play: function(){
      audio.src = this.src;
      audio.currentTime = this.pausedAt || 0;
      audio.play();
      this.playing = this.src;
      if (!self.tracks) {
        return this.duration = this.data.duration / 1000.0;
      } else {
        return this.duration = audio.duration;
      }
    },
    pause: function(){
      audio.pause();
      this.pausedAt = this.currentTime;
      this.fire('pause', {
        pausedAt: this.pausedAt,
        playing: this.src
      });
      return this.playing = false;
    },
    setTimer: function(speed){
      var self, interval;
      speed == null && (speed = 1000);
      self = this;
      return interval = setInterval(function(){
        var progress;
        if (self.currentTime === audio.duration) {
          self.pausedAt = self.currentTime;
          self.pause();
          console.log(this);
          clearInterval(interval);
          if (self.tracks) {
            console.log('This is a playlist');
            console.log(self.tracks);
            return console.log('index', _.findIndex(self.tracks, {
              'title': self.data.title
            }));
          }
        } else if (self.playing === self.src) {
          self.currentTime = audio.currentTime;
          if (!self.tracks) {
            progress = 100 * self.currentTime / self.duration;
          } else {
            progress = 100 * self.currentTime / audio.duration;
          }
          return self.set('progress', progress);
        } else {
          return clearInterval(interval);
        }
      }, speed);
    },
    playPause: function(e){
      var self;
      self = this;
      if (audio.readyState && this.currentTime === audio.duration) {
        audio.currentTime = 0;
        this.currentTime = 0;
        this.pausedAt = this.currentTime;
      }
      if (!this.playing) {
        this.fire('play', {
          playing: this.src
        });
        this.play();
        return this.setTimer();
      } else {
        return this.pause();
      }
    },
    seek: function(e){
      var percent, time;
      percent = e.offsetX / e.target.offsetWidth || (e.layerX - e.target.offsetLeft) / e.target.offsetWidth;
      time = percent * this.duration || 0;
      audio.currentTime = time;
      this.pausedAt = audio.currentTime;
      if (audio.src !== this.src) {
        return this.playPause();
      }
    }
  });
}).call(this);
</script></dom-module>