
<link rel="import" href="../../bower_components/polymer/polymer.html"/>
<link rel="import" href="../play-button/play-button.html"/>
<link rel="import" href="../player-data/player-data.html"/>
<link rel="import" href="../progress-bar/progress-bar.html"/>
<link rel="import" href="../player-timer/player-timer.html"/>
<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html"/>
<dom-module id="audio-player">
  <template>
    <style>:host {
  display: flex;
  padding: 10px;
  margin-bottom: 20px;
  border-radius: 4px;
  background: RGBA(46, 66, 184, 1);
  color: #fff;
}
img.play-button {
  border-radius: 50%;
}
.progress-seeker {
  position: absolute;
  top: 0;
  cursor: pointer;
  z-index: 10;
  width: 100%;
  height: 100%;
}

    </style>
    <iron-ajax id="ajax" auto="auto" url="{{uri}}" params="{{ajaxParams}}" handle-as="json" debounce-duration="300" on-response="onResponse"></iron-ajax>
    <play-button on-click="playPause" paused="[[paused]]" playing="[[playing]]" artwork="[[artwork]]"></play-button>
    <player-data track="[[data]]"> 
      <player-timer time="[[_secondesToMinutesAndSeconds(currentTime)]]"></player-timer>
      <progress-bar progress="[[progress]]">
        <div on-click="seek" class="progress-seeker"></div>
      </progress-bar>
      <player-timer time="[[_secondesToMinutesAndSeconds(duration)]]"></player-timer>
    </player-data>
    <content></content>
  </template>
  <script>// Generated by LiveScript 1.4.0
(function(){
  var audio;
  audio = document.createElement('audio');
  Polymer({
    is: 'audio-player',
    ready: function(){
      this.name = "Audio player";
      return this.parentNode.addEventListener('play', function(e){
        if (this.playing && e.detail.playing !== this.src) {
          this.pausedAt = this.currentTime;
          return this.playPause();
        }
      }.bind(this));
    },
    listeners: {
      'click': 'handleClick',
      'play': 'handlePlay',
      'pause': 'handlePause'
    },
    handleClick: function(e){
      return console.log(e);
    },
    handlePlay: function(e){
      return console.log('play', this.data.title, e);
    },
    handlePause: function(e){
      return console.log('pause', this.data.title, e);
    },
    hostAttributes: {
      tabindex: 0
    },
    onResponse: function(request){
      this.data = request.detail.response;
      return this.src = this.data.stream_url + '?client_id=' + this.soundcloudClientId;
    },
    properties: {
      progress: {
        type: Number
      },
      duration: {
        type: Number,
        notify: true
      },
      currentTime: {
        type: Number,
        notify: true
      },
      data: {
        type: Object,
        notify: true
      },
      artwork: {
        type: String,
        computed: '_computeArtworkUrl(data)',
        readOnly: true
      },
      uri: {
        type: String,
        value: 'https://api.soundcloud.com/resolve'
      },
      url: {
        type: String,
        notify: true
      },
      src: {
        type: String,
        notify: true
      },
      soundcloudClientId: {
        type: String,
        value: 'd97078ee059112b89104629451ea6cf1'
      },
      playing: {
        type: Boolean,
        notify: true,
        value: false
      },
      paused: {
        type: Boolean,
        notify: true,
        value: false
      },
      pausedAt: {
        type: Number,
        notify: true
      },
      ajaxParams: {
        type: Object,
        computed: '_computeAjaxParams(url, soundcloudClientId)'
      }
    },
    _computeArtworkUrl: function(data){
      return data.artwork_url || data.user.avatar_url;
    },
    _secondesToMinutesAndSeconds: function(seconds){
      var minutes;
      if (this.playing !== this.src || !this.playing) {
        return;
      }
      minutes = Math.floor(seconds / 60);
      minutes = minutes >= 10
        ? minutes
        : '0' + minutes;
      seconds = Math.floor(seconds % 60);
      seconds = seconds >= 10
        ? seconds
        : '0' + seconds;
      return minutes + ':' + seconds;
    },
    _computeAjaxParams: function(url, soundcloudClientId){
      return {
        url: url,
        client_id: soundcloudClientId
      };
    },
    play: function(){
      audio.src = this.src;
      audio.currentTime = this.pausedAt || 0;
      audio.play();
      return this.playing = this.src;
    },
    pause: function(){
      audio.pause();
      this.pausedAt = this.currentTime;
      this.fire('pause', {
        pausedAt: this.pausedAt
      });
      return this.playing = false;
    },
    playPause: function(e){
      var self, interval;
      self = this;
      if (this.currentTime === audio.duration) {
        audio.currentTime = 0;
        this.currentTime = 0;
        this.pausedAt = this.currentTime;
      }
      if (!this.playing) {
        this.fire('play', {
          playing: this.src
        });
        this.play();
        this.duration = this.data.duration / 1000.0;
        return interval = setInterval(function(){
          var progress;
          if (self.currentTime === audio.duration) {
            self.pausedAt = self.currentTime;
            self.pause();
            clearInterval(interval);
          }
          if (self.playing) {
            self.currentTime = audio.currentTime;
            progress = 100 * self.currentTime / self.duration;
            return self.set('progress', progress);
          } else {
            return clearInterval(interval);
          }
        }, 1000);
      } else {
        this.pause();
        return clearInterval(interval);
      }
    },
    seek: function(e){
      var percent, time;
      if (audio.src !== this.src) {
        return false;
      }
      if (!audio.readyState) {
        return false;
      }
      percent = e.offsetX / e.target.offsetWidth || (e.layerX - e.target.offsetLeft) / e.target.offsetWidth;
      time = percent * audio.duration || 0;
      audio.currentTime = time;
      return this.pausedAt = audio.currentTime;
    }
  });
}).call(this);

  </script>
</dom-module>