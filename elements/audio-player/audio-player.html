
<link rel="import" href="../../bower_components/polymer/polymer.html"/>
<link rel="import" href="../play-button/play-button.html"/>
<link rel="import" href="../player-data/player-data.html"/>
<link rel="import" href="../progress-bar/progress-bar.html"/>
<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html"/>
<dom-module id="audio-player">
  <template>
    <style>:host {
  display: flex;
  padding: 10px;
  margin-bottom: 20px;
  border-radius: 4px;
  background: RGBA(46, 66, 184, 1);
  color: #fff;
}
img.play-button {
  border-radius: 50%;
}
.progress-seeker {
  position: absolute;
  top: 0;
  cursor: pointer;
  z-index: 10;
  width: 100%;
  height: 100%;
}

    </style>
    <iron-ajax id="ajax" auto="auto" url="{{uri}}" params="{{ajaxParams}}" handle-as="json" debounce-duration="300" on-response="onResponse"></iron-ajax>
    <play-button on-click="playPause" paused="[[paused]]" playing="[[playing]]" artwork="[[artwork]]"></play-button>
    <player-data track="[[data]]"> 
      <progress-bar progress="[[progress]]">
        <div on-click="seek" class="progress-seeker"></div>
      </progress-bar>
    </player-data>
    <content></content>
  </template>
  <script>// Generated by LiveScript 1.4.0
(function(){
  var audio;
  audio = document.createElement('audio');
  Polymer({
    is: 'audio-player',
    ready: function(){
      this.name = "Audio player";
      this.currentTime = audio.currentTime || 0;
      this.duration = audio.duration || 0;
      return this.progress = this.currentTime / this.duration;
    },
    hostAttributes: {
      tabindex: 0
    },
    onResponse: function(request){
      this.data = request.detail.response;
      return this.src = this.data.stream_url + '?client_id=' + this.soundcloudClientId;
    },
    properties: {
      progress: {
        type: Number,
        notify: true
      },
      duration: {
        type: Number,
        notify: true
      },
      currentTime: {
        type: Number,
        observer: '_currentTimeChanged',
        notify: true
      },
      data: {
        type: Object,
        notify: true,
        reflectToAttribute: true
      },
      artwork: {
        type: String,
        notify: true,
        computed: 'computeArtworkUrl(data)',
        readOnly: true,
        reflectToAttribute: true
      },
      uri: {
        type: String,
        value: 'https://api.soundcloud.com/resolve'
      },
      url: {
        type: String,
        notify: true
      },
      src: {
        type: String,
        notify: true
      },
      soundcloudClientId: {
        type: String,
        value: 'd97078ee059112b89104629451ea6cf1'
      },
      playing: {
        type: Boolean,
        notify: true,
        value: false
      },
      paused: {
        type: Boolean,
        notify: true,
        value: false
      },
      ajaxParams: {
        type: Object,
        computed: 'computeAjaxParams(url, soundcloudClientId)'
      }
    },
    computeArtworkUrl: function(data){
      return data.artwork_url || data.user.avatar_url;
    },
    _currentTimeChanged: function(newValue, oldValue){
      var progress;
      this.duration = audio.duration;
      this.currentTime = audio.currentTime;
      progress = 100 * this.currentTime / this.duration;
      if (this.src === audio.src) {
        return this.set('progress', progress);
      }
    },
    computeAjaxParams: function(url, soundcloudClientId){
      return {
        url: url,
        client_id: soundcloudClientId
      };
    },
    play: function(){
      if (this.src !== audio.src) {
        audio.src = this.src;
      }
      if (this.paused) {
        audio.currentTime = this.paused;
      }
      audio.play();
      return this.playing = true;
    },
    pause: function(){
      audio.pause();
      this.paused = this.currentTime;
      return this.playing = false;
    },
    playPause: function(e){
      var self, interval;
      self = this;
      this.duration = audio.duration;
      if (!this.playing) {
        interval = setInterval(function(){
          if (self.currentTime === self.data.duration) {
            clearInterval(interval);
            self.pause();
          }
          return self.currentTime = audio.currentTime;
        }, 15);
        return this.play();
      } else {
        clearInterval(interval);
        return this.pause();
      }
    },
    seek: function(e){
      var percent, time;
      if (!audio.readyState) {
        return false;
      }
      percent = e.offsetX / e.target.offsetWidth || (e.layerX - e.target.offsetLeft) / e.target.offsetWidth;
      time = percent * audio.duration || 0;
      return audio.currentTime = time;
    }
  });
}).call(this);

  </script>
</dom-module>